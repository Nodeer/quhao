<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>上海所有商家查询</title>
<script language="javascript" src="http://webapi.amap.com/maps?v=1.2&key=60d9c5881dbe8dddd3de33aaacac0cbe"></script>
<script language="javascript" src="/public/javascripts/libs/jquery-1.7.js"></script>
<script language="javascript">
var mapObj;
var page = 1;

// 循环distincts的下标
var index = 0;	
var MSearch;
//中心点坐标
var cpoint = new AMap.LngLat(121.472644, 31.231706);
var distincts = [[121.223543, 31.03047],[121.113021, 31.151209],[121.567706, 31.245944],[121.526372, 31.287991],[121.567706, 31.245944],[121.489934, 31.398896],[121.397516, 31.626946],[121.390478, 31.205262],[121.458472, 30.912345],[121.378947, 31.138349],[121.448224, 31.229003],[121.43752, 31.179973],[121.490317, 31.222771],[121.330736, 30.724697],[121.250333, 31.383524],[121.490317, 31.222771],[121.392499, 31.241701],[121.491832, 31.26097],[121.465689, 31.25318]];

function mapInit() {
    //加载地图
    mapObj = new AMap.Map("iCenter");
    
}
//地点查询函数
function placeSearch(page,distinct) {
	if(distinct != null){
		console.log(distinct[0]);
	    console.log(distinct[1]);
	   
	    cpoint = new AMap.LngLat(distinct[0],distinct[1]);
		
	}
    //加载服务插件，实例化地点查询类  
    mapObj.plugin(["AMap.PlaceSearch"], function() {
        MSearch = new AMap.PlaceSearch({ 
            city: "上海",
            pageSize: 50,
            pageIndex: page
        }); 
        //查询成功时的回调函数
        AMap.event.addListener(MSearch, "complete", placeSearch_CallBack); 
        AMap.event.addListener(MSearch, "error", placeSearch_CallBack_Error); 
       MSearch.searchNearBy("餐饮", cpoint, 50000); 
    });
}

function placeSearch_CallBack_Error(data){
	alert(data);
}

//回调函数 
function placeSearch_CallBack(data) {
	console.log(data.poiList.count);
	var resultStr = "";
    var poiArr = data.poiList.pois;
    var resultCount = data.poiList.pois.length;
    if(data.poiList.pois.length > 0){
    	console.log("current page : " + page);
    	console.log("current page's poi : " + data.poiList.pois.length);
	    for (var i = 0; i < data.poiList.pois.length; i++) {
	        resultStr = "citycode:021|"+"poiid:"+poiArr[i].id+"|name:"+poiArr[i].name+"|address:"+poiArr[i].address+"|location:"+poiArr[i].location+"|tel:"+poiArr[i].tel+"|type:"+poiArr[i].type+"</br>"
	        $("#result").append(resultStr);
	    }
	    page++;
	    placeSearch(page);
    } else {
    	$("#tip").append("爬取结束&nbsp;&nbsp;&nbsp;&nbsp;");
    	if(index < distincts.length){
    		page = 1;
    		placeSearch(page,distincts[index]);
    		index++;
    		console.log("第"+index+"区");
    	}
    }
}

function startplaceSearch(){
	placeSearch(1,distincts[0]);
	index++;
	console.log("第"+index+"区");
}

</script>
</head>
<body onload="mapInit();">  
    <div id="iCenter" style="display: none;"></div>
    <div class="">
        上海所有商家<input type="button" value="查询" onclick="startplaceSearch();"/><br />
        <div id="tip"></div>
        <div id="result"> </div>
    </div>        
</body>
</html>